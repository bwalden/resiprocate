
pipeline {
    agent none
    options {
        timestamps()
    }
    stages {
        stage('Linux'){
            matrix {
                axes {
                    axis {
                        name 'DISTRO'
                        values 'alpine', 'ubuntu'
                    }
                }
                agent {
                    dockerfile {
                        dir "build/jenkins/${DISTRO}"
                    }
                }
                stages {
                    stage('Bootstrap'){
                        steps {
                            sh 'autoreconf --install'
                            sh 'rm resip/stack/gen/*'
                        }
                    }
                    stage('Configure'){
                        steps {
                            sh "./configure --enable-assert-syslog \
                                            --enable-dtls \
                                            --enable-ipv6 \
                                            --enable-repro-plugins \
                                            --with-apps \
                                            --with-c-ares \
                                            --with-mysql \
                                            --with-netsnmp \
                                            --with-popt \
                                            --with-postgresql \
                                            --with-python \
                                            --with-qpid-proton \
                                            --with-radcli \
                                            --with-recon \
                                            --with-rend \
                                            --with-repro \
                                            --with-return \
                                            --with-ssl \
                                            --with-telepathy \
                                            CPPFLAGS=\"-D__pingtel_on_posix__ -D_FILE_OFFS -D_REENTRANT -D_linux_ -DDEFAULT_BRIDGE_MAX_IN_OUTPUTS=20 -DRESIP_DIGEST_LOGGING -I${WORKSPACE}/contrib/cajun/include -I/usr/include/mysql -I/usr/include/sipxtapi -I/usr/include/soci `net-snmp-config --base-cflags`\" \
                                            CXXFLAGS=\"-Wformat -Werror=format-security -fpermissive\" \
                                            DEPS_PYTHON_CFLAGS=\"`/usr/bin/python3.8-config --cflags`\" \
                                            DEPS_PYTHON_LIBS=\"`/usr/bin/python3.8-config --ldflags`\" \
                                            PYCXX_SRCDIR=/usr/share/python3.8/CXX/Python3"
                        }
                    }
                    stage('Build'){
                        steps {
                            sh 'make'
                        }
                    }
                    stage('Test'){
                        steps {
                            sh 'make check'
                        }
                    }
                }
                post {
                    always {
                        recordIssues (
                            tools: [
                                gcc(
                                    id: "${DISTRO}-gcc",
                                    name: "${DISTRO} - GNU C Compiler (gcc)"
                                )
                            ]
                        )
                    }
                    cleanup {
                        cleanWs()
                    }
                }
            }
        }
        stage('Windows'){
            matrix {
                axes {
                    axis {
                        name 'CONFIGURATION'
                        values 'SSL-Release'
                    }
                    axis {
                        name 'PLATFORM'
                        values 'x64'
                    }
                }
                agent {
                    dockerfile {
                        dir 'build/jenkins/windows'
                    }
                }
                stages {
                    stage('resip'){
                        steps {
                            bat "msbuild -m -p:Configuration=${CONFIGURATION};Platform=${PLATFORM} reSIProcate_16_0.sln"
                        }
                    }
                    stage('reTurn'){
                        steps {
                            dir('reTurn'){
                                bat "msbuild -m -p:Configuration=${CONFIGURATION};Platform=${PLATFORM} reTurn_16_0.sln"
                            }
                        }
                    }
                    stage('tfm'){
                        steps {
                            dir('tfm'){
                                bat "msbuild -m -p:Configuration=${CONFIGURATION};Platform=${PLATFORM} tfm_16_0.sln"
                            }
                        }
                    }
                }
                post {
                    always {
                        recordIssues (
                            tools: [
                                msBuild()
                            ]
                        )
                    }
                    cleanup {
                        cleanWs()
                    }
                }
            }
        }
    }
}